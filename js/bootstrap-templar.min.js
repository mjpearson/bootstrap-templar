!function(c){var b=function(e,d){this.$element=c(e);this.options=c.extend({},c.fn.templar.defaults,d);this.tokens=0;this.listen()};c.fn.templarInputScale=function(d){d=c.extend({maxWidth:1000,minWidth:0,comfortZone:0},d);this.filter("input:text").each(function(){var h=d.minWidth||c(this).width(),i="",f=c(this),g=c("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:f.css("fontSize"),fontFamily:f.css("fontFamily"),fontWeight:f.css("fontWeight"),letterSpacing:f.css("letterSpacing"),whiteSpace:"nowrap"}),e=function(n){if(n.type!="templar-force-scale"&&i===(i=f.val())){return}var o=i.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");g.html(o);var l=g.width(),m=(l+d.comfortZone)>=h?l+d.comfortZone:h,k=f.width(),j=(m<k&&m>=h)||(m>h&&m<d.maxWidth);if(j){f.width(m)}};g.insertAfter(f);c(this).bind("keyup keydown blur update templar-force-scale",e)});return this};c.fn.templarCursorPosGet=function(){var f=c(this).get(0);var g=0;if("selectionStart" in f){g=f.selectionStart}else{if("selection" in document){f.focus();var d=document.selection.createRange();var e=document.selection.createRange().text.length;d.moveStart("character",-f.value.length);g=d.text.length-e}}return g};c.fn.templarCursorPosSet=function(e){if(c(this).get(0).setSelectionRange){c(this).get(0).setSelectionRange(e,e)}else{if(c(this).get(0).createTextRange){var d=c(this).get(0).createTextRange();d.collapse(true);d.moveEnd("character",e);d.moveStart("character",e);d.select()}}};b.prototype={constructor:b,_templateKey:null,_getType:function(d){return Object.prototype.toString.call(d)},_isObject:function(d){return(this._getType(d)=="[object Object]")},_isArray:function(d){return(this._getType(d)=="[object Array]")},_sortSlice:function(e,d){if(e.start>d.start){return 1}else{if(e.start<d.start){return -1}else{if(e.start==d.start){return 0}}}},listen:function(){if(!this.$element.hasClass("templar")){this.$element.addClass("templar")}this.$element.on("click",function(d){var i;if(d.target===this){i=c(this).children("input:last");i.focus().templarCursorPosSet(i.val().length)}});this._templateKey=new RegExp(this.options.templateKey);var s=this._addInput();if(this.options.data){var q,r,n,w=this.options.data,f=[],t,l=0,h;for(var z in this.options.tags){for(var v=0;v<this.options.tags[z].data.length;v++){h=z+this.options.delimiter+(this._isObject(this.options.tags[z].data[v])?this.options.tags[z].data[v].value:this.options.tags[z].data[v]);q=this.options.template.replace(this._templateKey,h);var j=0,e=q.length;var m;while((m=w.indexOf(q,j))>-1){f.push({tag:true,value:q,actualValue:h,labelValue:this.options.tags[z].data[v].label,start:m,end:m+e-1});j=m+e}}}f=f.sort(this._sortSlice);var g=[];var k=0,u;v=0;while(v<w.length){u=f.shift();if(u){g.push(u);if(u.start>v){g.push({tag:false,value:w.substr(v,u.start-v),start:v,end:u.start})}v=u.end}else{g.push({tag:false,value:w.substr(v,w.length-v),start:v,end:w.length});v=w.length}v++}g.sort(this._sortSlice);var p=s,y=p,o,x=this.$element;for(var v=0;v<g.length;v++){if(g[v].tag){p=this._addTag(p,g[v].actualValue,g[v].labelValue);o=p.tag;y=p.txt}else{y.val(g[v].value);y.templarCursorPosSet(g[v].value.length)}p=y}}if(this.eventSupported("keydown")){this.$element.children(":input").on("keydown",c.proxy(this.keydown,this))}},eventSupported:function(d){var e=d in this.$element.children(":input");if(!e){this.$element.setAttribute(d,"return;");e=typeof this.$element[d]==="function"}return e},_emit:function(){this.computeTemplate();this.$element.trigger("templar-template")},computeTemplate:function(){var g="",d="",e=this,f=this.$element.children();c.each(f,function(h,i){if(i.localName=="input"){g+=c(i).val()}else{d=c(i).find(".templar-select-label").attr("data-selected-tag");;if(d){g+=e.options.template.replace(e._templateKey,d)}}});this.$element.attr("data-template",g);return g},_lastFocusLength:0,_lastCursorPos:0,inputKeyup:function(f,h){var g=c(f.currentTarget),e,d;h=h||false;if(this.options.keyEvent(f)){this._addTag(g)}else{if(f.keyCode==8){this._lastFocusLength--;if((g.templarCursorPosGet()==0&&g.val()!="")||(g.val()==""&&this._lastFocusLength<0)){e=g.prevAll("div.btn-group:first");this._removeTag(e)}this._emit()}else{if(f.keyCode==46){if(g.templarCursorPosGet()==g.val().length&&this._lastFocusLength>0){d=g.nextAll("div.btn-group:first");this._removeTag(d)}}else{if(f.keyCode==35&&!f.shiftKey){g.nextAll("input:last").focus();g.templarCursorPosSet(g.val().length)}else{if(f.keyCode==36&&!f.shiftKey){g.prevAll("input:last").focus();g.templarCursorPosSet(0)}else{if(f.keyCode==37){if(h){g.prevAll("input:first").focus();g.dropdown("toggle")}else{if(this._lastCursorPos==g.templarCursorPosGet()){g.prevAll("div.btn-group:first").find("button").focus().dropdown("toggle")}}}else{if(f.keyCode==39){if(h){g.nextAll("input:first").focus().templarCursorPosSet(0);g.dropdown("toggle")}else{if(this._lastCursorPos==g.templarCursorPosGet()){g.nextAll("div.btn-group:first").find("button").focus().dropdown("toggle")}}}else{this._emit()}}}}}}}this._lastCursorPos=g.templarCursorPosGet();this._lastFocusLength=g.val().length;f.stopPropagation();f.preventDefault()},_addInput:function(g,f){var d=c('<input type="text" width="20px" autocomplete="off" value="'+(f||"")+'" />');if(g){g.after(d)}else{var e=this.$element.append(d)}d.focus();d.templarInputScale({comfortZone:8,minWidth:10});d.on("focus",c.proxy(this.focus,this)).on("blur",c.proxy(this.blur,this)).on("keypress",c.proxy(this.keypress,this)).on("keyup",c.proxy(this.inputKeyup,this));d.trigger("templar-force-scale");this._emit();return d},_addTag:function(d,m,k){var o=this,e,f,i,l,h,g,j;var n=c(this._addTagHtml(m,k));l=d.templarCursorPosGet();if(l!=d.val().length){h=d.val().substring(l,d.val().length);d.val(d.val().substring(0,l-1))}e=d.after(n);this._tagOpen=true;j=o._addInput(n,h);j.trigger("templar-force-scale");i=n.next();f=n.prev();n.find("li a").click(function(p){var q=c(this);p.preventDefault();c(".templar-select-label",n).html(q.text());c(".templar-select-label",n).attr("data-selected-tag",q.attr("data-tag"));o._tagOpen=false});n.on("click",function(p){var r=c(this),q;p.preventDefault();if(""==c(".templar-select-label",r).attr("data-selected-tag")){o._removeTag(r)}else{q=c(this).prev().val();q=q.replace(new RegExp("\\"+o.options.character+"$"),"");c(this).prev().val(q);r.nextAll("input:first").focus();o._emit()}o._activeTag=null});n.on("keydown.dropdown.data-api",function(p){o.inputKeyup(p,true)});n.find("button").focus();return{tag:n,txt:j}},_removeTag:function(f){var g=f.prevAll("input:first"),e=f.nextAll("input:first"),d;if(g.val()){d=g.val().length;f.remove();if(g.length===1&&e.length===1){var h=g.val()+e.val();g.val(h);e.remove();g.trigger("keyup");g.focus();g.templarCursorPosSet(d);this._lastFocusLength=g.val().length;this._emit()}}},_addTagHtml:function(j,d){var h="",k=this.options,e,l;if(!d){d=(j?j.split(k.delimiter)[1]:"Select")}h+='<div class="btn-group '+(j?"":"open")+'">';h+='    <button data-selected-tag="'+(j||"")+'" class="btn btn-small btn-success templar-select-label">'+d+"</button>";h+='    <button class="btn btn-small btn-success dropdown-toggle" data-toggle="dropdown">';h+='        <span class="caret"></span>';h+="    </button>";h+='    <ul class="dropdown-menu" role="menu">';for(var g in k.tags){h+='            <li class="dropdown-submenu title"><a tabinxex="-1" href="#"> '+(k.tags[g].label?k.tags[g].label:g.label)+"</a>";h+='                <ul class="dropdown-menu">';for(var f=0;f<k.tags[g].data.length;f++){e=this._isObject(k.tags[g].data[f])?k.tags[g].data[f]["label"]:k.tags[g].data[f];l=this._isObject(k.tags[g].data[f])?k.tags[g].data[f]["value"]:k.tags[g].data[f];h+='                <li><a data-tag="'+g+k.delimiter+l+'" href=""><i class="icon-chevron-right"></i> '+e+"</a></li>"}h+="                </ul>";h+="            </li>"}h+="    </ul>";h+="</div>";return h}};var a=c.fn.templar;c.fn.templar=function(d){return this.each(function(){var g=c(this),f=g.data("templar"),e=typeof d=="object"&&d;if(!f){g.data("templar",(f=new b(this,e)))}if(typeof d=="string"){f[d]()}})};c.fn.templar.defaults={tags:[],templateKey:"value",template:"",delimiter:".",character:"[",keyEvent:function(d){return d.keyCode===219}};c.fn.templar.defaults.template=c.fn.templar.defaults.templateKey;c.fn.templar.Constructor=b;c.fn.templar.noConflict=function(){c.fn.templar=a;return this}}(window.jQuery);