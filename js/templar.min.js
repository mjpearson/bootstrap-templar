!function(c){var b=function(e,d){this.$element=c(e);this.options=c.extend({},c.fn.templar.defaults,d);this.tokens=0;this.listen()};b.prototype={constructor:b,_templateKey:null,_getType:function(d){return Object.prototype.toString.call(d)},_isObject:function(d){return(this._getType(d)=="[object Object]")},_isArray:function(d){return(this._getType(d)=="[object Array]")},_sortSlice:function(e,d){if(e.start>d.start){return 1}else{if(e.start<d.start){return -1}else{if(e.start==d.start){return 0}}}},_escapeRegExp:function(d){return d.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},getSelection:function(){var d;if(window.getSelection&&window.getSelection().rangeCount>0){d=window.getSelection().getRangeAt(0).cloneRange()}else{if(document.selection){d=document.selection.createRange()}}return d},updateFocus:function(e){var d=document.createRange();var f=window.getSelection();d.setStart(e,0);d.collapse(true);f.removeAllRanges();f.addRange(d)},getSelect:function(g){var h=this.options,d,j,k='<span class="templar-select" contenteditable="false"><select><option value=""></option>';for(var f in h.tags){k+='<optgroup data-index="'+f+'" label="'+(h.tags[f].label?h.tags[f].label:f.label)+'">';for(var e=0;e<h.tags[f].data.length;e++){d=this._isObject(h.tags[f].data[e])?h.tags[f].data[e]["label"]:h.tags[f].data[e];j=this._isObject(h.tags[f].data[e])?h.tags[f].data[e]["value"]:h.tags[f].data[e];j=f+h.delimiter+j;k+="<option "+(g===j?'selected="selected"':"")+' value="'+j+'">'+d+"</option>"}k+="</optgroup>"}k+="</select></span>";return k},listen:function(){var j,e,h=this.options.data,k,d=this;if(!this.$element.hasClass("templar")){this.$element.addClass("templar")}this.$element.attr("contenteditable","plaintext-only");this._templateKey=new RegExp(this.options.templateKey);for(var g in this.options.tags){for(var f=0;f<this.options.tags[g].data.length;f++){k=g+this.options.delimiter+(this._isObject(this.options.tags[g].data[f])?this.options.tags[g].data[f].value:this.options.tags[g].data[f]);j=this._escapeRegExp(this.options.template.replace(this._templateKey,k));e=new RegExp(j,"g");h=h.replace(e,this.getSelect(k))}}this.$element.html(h);this._addTag(c(".templar-select select"));this.$element.on("keydown",function(o){var m=d.getSelection(),l,p=c(this);if(d.options.keyEvent(o)){o.stopPropagation();l=c(d.getSelect());m.insertNode(l[0]);var i=c("select",l);var n=document.createTextNode("\u00a0");d._addTag(i,n);m.setStartAfter(l[0]);m.insertNode(n);i.select2("open")}else{if(o.keyCode===13){o.stopPropagation();o.preventDefault()}}setTimeout(function(){d._emit(p)},10)});this._emit(this.$element)},_addTag:function(e,f){var d=this;(function(g,h){g.select2(d.options.select2).on("change",function(){if(h){d.updateFocus(h)}d.$element.focus();d._emit(d.$element)}).on("select2-close",function(){if(""===c(":selected",g).val()){g.parent().remove();if(h){d.updateFocus(h)}}d._emit(d.$element)})})(e,f)},_emit:function(d){d[0].normalize();this.computeTemplate();this.$element.trigger("templar-template")},computeTemplate:function(){var g="",d="",e=this,f=this.$element.contents();c.each(f,function(h,i){if(i.nodeName=="#text"){g+=c(i).text()}else{d=c("select",i).val();if(d){g+=e.options.template.replace(e._templateKey,d)}}});this.$element.attr("data-template",g);return g}};var a=c.fn.templar;c.fn.templar=function(d){return this.each(function(){var g=c(this),f=g.data("templar"),e=typeof d=="object"&&d;if(!f){g.data("templar",(f=new b(this,e)))}if(typeof d=="string"){f[d]()}})};c.fn.templar.defaults={tags:[],templateKey:"value",template:"",delimiter:".",buttonClass:"btn-primary",keyEvent:function(d){return(d.keyCode===73&&d.ctrlKey)}};c.fn.templar.defaults.template=c.fn.templar.defaults.templateKey;c.fn.templar.Constructor=b;c.fn.templar.noConflict=function(){c.fn.templar=a;return this}}(window.jQuery);